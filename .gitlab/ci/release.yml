# Mirror to GitHub for marketing presence
mirror:github:
  stage: release
  image: alpine/git:latest
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$GITHUB_DEPLOY_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H github.com >> ~/.ssh/known_hosts
  script:
    - git remote add github git@github.com:junevm/cdns.git
    - git fetch --unshallow origin || git fetch --all --prune
    - git push --mirror github
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# Create Release on GitLab and GitHub (via goreleaser)
release:goreleaser:
  stage: release
  image:
    name: goreleaser/goreleaser:latest
    entrypoint: [""]
  variables:
    GIT_DEPTH: 0 # Required for changelog generation
  script:
    - cd apps/cli
    - goreleaser release --clean
  artifacts:
    paths:
      - apps/cli/dist/releases.json
  rules:
    - if: $CI_COMMIT_TAG
